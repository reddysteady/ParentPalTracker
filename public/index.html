<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ParentPal - School Email & Schedule Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 24px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #333; /* Default text color */
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .event-item, .child-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .event-date {
            font-weight: bold;
            color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background-color: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                margin-bottom: 5px;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ParentPal</h1>
            <p class="subtitle">Smart School Email & Schedule Management</p>
        </div>
    </header>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('children')">Children</button>
            <button class="nav-tab" onclick="showTab('events')">Events</button>
            <button class="nav-tab" onclick="showTab('gmail')">Gmail Integration</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>üìÖ Today's Events</h3>
                    <div id="todayEvents">
                        <div class="loading">Loading today's events...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä System Status</h3>
                    <div id="dashboardStatus">
                        <div class="loading">Checking system status...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üéØ Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showTab('children')" class="btn-secondary">Add Child</button>
                    <button onclick="showTab('events')" class="btn-secondary">Add Event</button>
                    <button onclick="connectGmail()" class="btn-success">Connect Gmail</button>
                    <button onclick="syncGmail()" class="btn-secondary" disabled>Sync Emails (Connect Gmail First)</button>
                </div>
            </div>
        </div>

        <!-- Children Tab -->
        <div id="children" class="tab-content">
            <div class="card">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Add New Child</h3>
                <form onsubmit="addChild(event)">
                    <div class="form-group">
                        <label for="childName">Child's Name:</label>
                        <input type="text" id="childName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="childGrade">Grade:</label>
                        <input type="text" id="childGrade" name="grade" required>
                    </div>
                    <div class="form-group">
                        <label for="childSchool">School:</label>
                        <input type="text" id="childSchool" name="school" required>
                    </div>
                    <button type="submit">Add Child</button>
                </form>
            </div>

            <div class="card">
                <h3>üìã Your Children</h3>
                <div id="childrenList">
                    <div class="loading">Loading children...</div>
                </div>
            </div>
        </div>

        <!-- Events Tab -->
        <div id="events" class="tab-content">
            <div class="card">
                <h3>üìÖ Add New Event</h3>
                <form onsubmit="addEvent(event)">
                    <div class="form-group">
                        <label for="eventTitle">Event Title:</label>
                        <input type="text" id="eventTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDate">Date:</label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventTime">Time:</label>
                        <input type="time" id="eventTime" name="eventTime">
                    </div>
                    <div class="form-group">
                        <label for="eventChild">Child:</label>
                        <select id="eventChild" name="childId">
                            <option value="">Select a child</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Description:</label>
                        <textarea id="eventDescription" name="description" rows="3"></textarea>
                    </div>
                    <button type="submit">Add Event</button>
                </form>
            </div>

            <div class="card">
                <h3>üìã Upcoming Events</h3>
                <div id="eventsList">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>

        <!-- Gmail Integration Tab -->
        <div id="gmail" class="tab-content">
            <div class="card">
                <h3>üìß Gmail Integration</h3>
                <div id="gmailStatus">
                    <div class="loading">Checking Gmail connection...</div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="connectGmail()" class="btn-success">Connect Gmail</button>
                    <button onclick="syncGmail()" class="btn-secondary" style="margin-left: 10px;" disabled>Sync Emails (Connect Gmail First)</button>
                    <button onclick="toggleSyncSettings()" class="btn-secondary" style="margin-left: 10px;">Sync Settings</button>
                    <button onclick="startMonitoring()" class="btn-secondary" style="margin-left: 10px;">Start Monitoring</button>
                    <button onclick="debugOAuth()" class="btn-secondary" style="margin-left: 10px;">Debug OAuth</button>
                </div>

                <div id="debugInfo" style="margin-top: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 5px; display: none;">
                    <h4>OAuth Debug Information</h4>
                    <pre id="debugOutput"></pre>
                </div>
            </div>

            <!-- Email List Section -->
            <div class="card">
                <h3>üì¨ Synced Emails</h3>
                <div id="emailList">
                    <div class="loading">No emails synced yet. Click "Sync Emails" to get started.</div>
                </div>
            </div>

            <!-- Sync Settings - Initially Hidden -->
            <div class="card" id="sync-settings" style="display: none;">
                <h3>‚öôÔ∏è Email Processing Settings</h3>

                <!-- Email Limits Section -->
                <div style="margin-top: 20px;">
                    <h4>Email Processing Limits</h4>
                    <p style="color: #666; font-size: 14px; margin: 5px 0;">Configure the maximum number of emails to process and the age of emails to consider.  This helps reduce processing costs and improves accuracy.</p>

                    <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
                        <div>
                            <label for="max-emails">Max Emails to Process:</label>
                            <input type="number" id="max-emails" placeholder="e.g., 20" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="email-days">Email Age (Days):</label>
                            <input type="number" id="email-days" placeholder="e.g., 7" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <button onclick="saveEmailSettings()" class="btn-primary">Save Email Settings</button>
                </div>

                <!-- School Domains Section -->
                <div style="margin-top: 20px;">
                    <h4>School Email Domains</h4>
                    <p style="color: #666; font-size: 14px; margin: 5px 0;">Add your school's email domains to filter and process only relevant emails. This helps reduce processing costs and improves accuracy.</p>

                    <div style="display: flex; gap: 10px; margin: 15px 0;">
                        <input type="text" id="domain-input" placeholder="e.g., hillviewschool.edu" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="addDomain()" class="btn-primary">Add Domain</button>
                    </div>
                    <p style="color: #888; font-size: 12px;">Enter just the domain name (e.g., "school.edu" not "admin@school.edu")</p>

                    <div style="margin-top: 15px;">
                        <h5>Configured Domains:</h5>
                        <div id="domains-container">
                            <div class="loading">Loading domains...</div>
                        </div>
                    </div>
                </div>

                <!-- Processing Statistics Section -->
                <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <h4>Email Processing Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #007bff;" id="emails-processed">0</div>
                            <div style="font-size: 12px; color: #666;">Emails Processed</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;" id="events-extracted">0</div>
                            <div style="font-size: 12px; color: #666;">Events Extracted</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #6c757d;" id="last-sync">Never</div>
                            <div style="font-size: 12px; color: #666;">Last Sync</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="toggleSyncSettings()" class="btn-secondary">Hide Settings</button>
                </div>
            </div>

            <div class="card">
                <h3>‚ÑπÔ∏è How it works:</h3>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Connect your Gmail account securely</li>
                    <li>Configure your school's email domains above</li>
                    <li>We'll scan for school-related emails from those domains</li>
                    <li>Events are automatically extracted and added to your calendar</li>
                    <li>You'll get smart notifications based on your parenting schedule</li>
                </ol>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>üîî Notification Settings</h3>
                    <form onsubmit="saveNotificationSettings(event)">
                        <div class="form-group">
                            <label for="notificationEmail">Email for notifications:</label>
                            <input type="email" id="notificationEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label for="notificationPhone">Phone for SMS alerts:</label>
                            <input type="tel" id="notificationPhone" name="phone">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="dailyDigest" name="dailyDigest"> Daily digest emails
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="urgentAlerts" name="urgentAlerts"> Urgent SMS alerts
                            </label>
                        </div>
                        <button type="submit">Save Settings</button>
                    </form>
                </div>

                <div class="card">
                    <h3>ü§ñ AI Settings</h3>
                    <form onsubmit="saveGPTSettings(event)">
                        <div class="form-group">
                            <label for="gptModel">AI Model:</label>
                            <select id="gptModel" name="model">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gptTemperature">Response Style (0.0 = Precise, 1.0 = Creative):</label>
                            <input type="range" id="gptTemperature" name="temperature" min="0" max="1" step="0.1" value="0.3">
                            <span id="temperatureValue">0.3</span>
                        </div>
                        <div class="form-group">
                            <label for="customInstructions">Custom Instructions:</label>
                            <textarea id="customInstructions" name="customInstructions" rows="4" placeholder="Add any specific instructions for how the AI should process your emails..."></textarea>
                        </div>
                        <button type="submit">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let gmailTokens = null;

        // Tab navigation function
        function showTab(tabName) {
            // Store current tab in localStorage
            localStorage.setItem('currentTab', tabName);

            // Hide all tab contents
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });

            // Remove active class from all tabs
            const tabButtons = document.querySelectorAll('.nav-tab');
            tabButtons.forEach(button => {
                if (button && button.classList) {
                    button.classList.remove('active');
                }
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab && selectedTab.classList) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked button
            const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeButton && activeButton.classList) {
                activeButton.classList.add('active');
            }

            // Load tab-specific data
            if (tabName === 'gmail') {
                checkGmailConnection();
                loadEmailList();
                loadDomains();
                loadProcessingStats();
            } else if (tabName === 'events') {
                loadEvents();
                loadChildrenOptions();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'children') {
                loadChildren();
            }
        }

        // Dashboard functions
        function loadDashboard() {
            fetch('/api/health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const statusElement = document.getElementById('dashboardStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div>
                                <span class="status-indicator status-connected"></span>
                                Server is running
                            </div>
                            <p style="margin-top: 10px; color: #666;">Last updated: ${new Date(data.timestamp).toLocaleString()}</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard:', error);
                    const statusElement = document.getElementById('dashboardStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div>
                                <span class="status-indicator status-disconnected"></span>
                                Server connection failed
                            </div>
                            <p style="margin-top: 10px; color: #dc3545;">Error: ${error.message}</p>
                        `;
                    }
                });

            loadTodayEvents();
        }

        function loadTodayEvents() {
            fetch('/api/events')
                .then(response => response.json())
                .then(events => {
                    const today = new Date().toDateString();
                    const todayEvents = events.filter(event => {
                        return new Date(event.eventDate).toDateString() === today;
                    });

                    const container = document.getElementById('todayEvents');
                    if (container) {
                        if (todayEvents.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No events scheduled for today</p>';
                        } else {
                            container.innerHTML = todayEvents.map(event => `
                                <div class="event-item">
                                    <div class="event-date">${event.title}</div>
                                    <div>${event.eventTime ? `Time: ${event.eventTime}` : 'All day'}</div>
                                    ${event.description ? `<div style="margin-top: 5px; color: #666;">${event.description}</div>` : ''}
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading today events:', error);
                    const container = document.getElementById('todayEvents');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load events</div>`;
                    }
                });
        }

        // Children management
        function addChild(event) {
            event.preventDefault();

            const childData = {
                name: document.getElementById('childName').value,
                grade: document.getElementById('childGrade').value,
                school: document.getElementById('childSchool').value
            };

            fetch('/api/children', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(childData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Child added successfully!');
                event.target.reset();
                loadChildren();
                loadChildrenOptions();
            })
            .catch(error => {
                console.error('Error adding child:', error);
                alert('Error adding child: ' + error.message);
            });
        }

        function loadChildren() {
            fetch('/api/children')
                .then(response => response.json())
                .then(children => {
                    const container = document.getElementById('childrenList');
                    if (container) {
                        if (children.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No children added yet. Add your first child above!</p>';
                        } else {
                            container.innerHTML = children.map(child => `
                                <div class="child-item">
                                    <h4>${child.name}</h4>
                                    <p>Grade: ${child.grade} | School: ${child.school}</p>
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading children:', error);
                    const container = document.getElementById('childrenList');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load children</div>`;
                    }
                });
        }

        function loadChildrenOptions() {
            fetch('/api/children')
                .then(response => response.json())
                .then(children => {
                    const select = document.getElementById('eventChild');
                    if (select) {
                        select.innerHTML = '<option value="">Select a child</option>';
                        children.forEach(child => {
                            const option = document.createElement('option');
                            option.value = child.id;
                            option.textContent = child.name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading children options:', error);
                });
        }

        // Events management
        function addEvent(event) {
            event.preventDefault();

            const eventData = {
                title: document.getElementById('eventTitle').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                childId: document.getElementById('eventChild').value || null,
                description: document.getElementById('eventDescription').value
            };

            fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Event added successfully!');
                event.target.reset();
                loadEvents();
                loadTodayEvents();
            })
            .catch(error => {
                console.error('Error adding event:', error);
                alert('Error adding event: ' + error.message);
            });
        }

        function loadEvents() {
            fetch('/api/events')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(events => {
                    const container = document.getElementById('eventsList');
                    if (container) {
                        if (events.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No events scheduled. Add your first event above!</p>';
                        } else {
                            // Sort events by date
                            events.sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));

                            container.innerHTML = events.map(event => `
                                <div class="event-item">
                                    <div class="event-date">${new Date(event.eventDate).toDateString()}</div>
                                    <h4>${event.title}</h4>
                                    ${event.eventTime ? `<p>Time: ${event.eventTime}</p>` : ''}
                                    ${event.description ? `<p style="color: #666;">${event.description}</p>` : ''}
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    const container = document.getElementById('eventsList');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load events: ${error.message}</div>`;
                    }
                });
        }

        // Gmail integration functions
        function connectGmail() {
            // Check if Gmail tokens are already stored
            const tokens = localStorage.getItem('gmailTokens');
            if (tokens) {
                alert('Gmail is already connected! You can sync your emails.');
                return;
            }

            // Open OAuth in new window
            const authWindow = window.open('/api/auth/google', 'gmail-auth', 'width=500,height=600');

            // Listen for successful connection
            const messageListener = (event) => {
                if (event.data === 'gmail-connected') {
                    // Update Gmail connection status immediately
                    checkGmailConnection();

                    // Show success alert (simple solution)
                    alert('Gmail connected successfully! You can now sync your emails.');

                    // Clean up listener
                    window.removeEventListener('message', messageListener);
                } else if (event.data === 'gmail-error') {
                    // Show error alert
                    alert('Failed to connect Gmail. Please check the popup window for details.');

                    // Clean up listener
                    window.removeEventListener('message', messageListener);
                }
            };

            window.addEventListener('message', messageListener);
        }

        // Load email list
        async function loadEmailList() {
            try {
                const response = await fetch('/api/emails/1');
                const emailsData = await response.json();

                console.log('Loaded emails:', emailsData.length, 'emails for user', 1);

                const emailList = document.getElementById('emailList');
                if (emailsData.length === 0) {
                    emailList.innerHTML = '<div class="loading">No emails found. Click "Sync Emails" to get started.</div>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Data Source</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Sender</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Subject</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Date</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Status</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Event</th>';
                html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>';
                html += '</tr></thead><tbody>';

                emailsData.forEach(email => {
                    const date = new Date(email.receivedAt).toLocaleDateString();
                    const eventIcon = email.hasEvent ? 'üìÖ' : 'üìÑ';
                    const eventTooltip = email.hasEvent ? 'Event extracted' : 'No event found';

                    // Determine data source indicator
                    const isRealEmail = email.gmailMessageId && email.gmailMessageId.length > 10;
                    const dataSourceIcon = isRealEmail ? 'üì°' : 'üß™';
                    const dataSourceText = isRealEmail ? 'Gmail API' : 'Mock Data';
                    const dataSourceColor = isRealEmail ? '#28a745' : '#ffc107';
                    const dataSourceTooltip = isRealEmail ? 'Real email from Gmail API' : 'Mock/test data';

                    html += `<tr style="border-bottom: 1px solid #eee;">`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;" title="${dataSourceTooltip}">`;
                    html += `<span style="color: ${dataSourceColor}; font-weight: bold;">${dataSourceIcon} ${dataSourceText}</span>`;
                    html += `</td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee;">${email.sender}</td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${email.subject}</td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee;">${date}</td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee;"><span style="color: #28a745;">‚úì Synced</span></td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;" title="${eventTooltip}">${eventIcon}</td>`;
                    html += `<td style="padding: 12px; border-bottom: 1px solid #eee;">`;
                    html += `<button onclick="deleteEmail(${email.id})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">üóëÔ∏è Delete</button>`;
                    html += `</td>`;
                    html += `</tr>`;
                });

                html += '</tbody></table>';

                // Enhanced data source verification and debugging
                console.log('üîç Analyzing email data sources:', {
                    totalEmails: emailsData.length,
                    sampleEmails: emailsData.slice(0, 3).map(email => ({
                        id: email.id,
                        subject: email.subject?.substring(0, 30) + '...',
                        sender: email.sender,
                        gmailMessageId: email.gmailMessageId,
                        isTestData: email.gmailMessageId?.startsWith('test_') || email.sender?.includes('example.com'),
                        createdAt: email.createdAt
                    }))
                });

                const realEmails = emailsData.filter(email => {
                    const isReal = email.gmailMessageId && 
                                   !email.gmailMessageId.startsWith('test_') &&
                                   email.sender && 
                                   !email.sender.includes('example.com') &&
                                   !email.subject.includes('Test Email') &&
                                   !email.sender.includes('test@') &&
                                   !email.sender.includes('mock@');

                    if (!isReal) {
                        console.log('üß™ Detected mock/test email:', {
                            subject: email.subject?.substring(0, 30),
                            sender: email.sender,
                            gmailMessageId: email.gmailMessageId,
                            reasons: [
                                email.gmailMessageId?.startsWith('test_') ? 'test message ID' : null,
                                email.sender?.includes('example.com') ? 'example.com sender' : null,
                                email.subject?.includes('Test Email') ? 'test subject' : null,
                                email.sender?.includes('test@') ? 'test sender' : null,
                                email.sender?.includes('mock@') ? 'mock sender' : null
                            ].filter(Boolean)
                        });
                    }

                    return isReal;
                });

                const mockEmails = emailsData.length - realEmails.length;

                console.log('üìä Data source analysis complete:', {
                    realGmailEmails: realEmails.length,
                    mockTestEmails: mockEmails,
                    totalEmails: emailsData.length,
                    percentageReal: emailsData.length > 0 ? Math.round((realEmails.length / emailsData.length) * 100) : 0
                });

                const statsHtml = `
                    <div style="margin-top: 15px; padding: 10px; background: ${mockEmails > 0 ? '#fff3cd' : '#d4edda'}; border-radius: 5px; font-size: 14px; border-left: 4px solid ${mockEmails > 0 ? '#ffc107' : '#28a745'};">
                        <strong>Data Source Analysis:</strong><br>
                        üì° Real Gmail emails: <strong>${realEmails.length}</strong><br>
                        üß™ Mock/test emails: <strong>${mockEmails}</strong><br>
                        üìà Real data percentage: <strong>${emailsData.length > 0 ? Math.round((realEmails.length / emailsData.length) * 100) : 0}%</strong>
                        ${mockEmails > 0 ? '<br><span style="color: #856404;">‚ö†Ô∏è <strong>Mock data detected - not from real Gmail account</strong></span>' : '<br><span style="color: #155724;">‚úÖ <strong>All data is from real Gmail API</strong></span>'}
                    </div>
                `;

                emailList.innerHTML = html + statsHtml;

            } catch (error) {
                console.error('Error loading emails:', error);
                document.getElementById('emailList').innerHTML = '<div class="error">Error loading emails</div>';
            }
        }

        function toggleSyncSettings() {
            const settingsDiv = document.getElementById('sync-settings');
            const isHidden = settingsDiv.style.display === 'none';

            settingsDiv.style.display = isHidden ? 'block' : 'none';

            // Update button text
            const buttons = document.querySelectorAll('[onclick="toggleSyncSettings()"]');
            buttons.forEach(button => {
                button.textContent = isHidden ? 'Hide Settings' : 'Sync Settings';
            });
        }

        function viewEmail(emailId) {
            console.log('Viewing email:', emailId);
            alert(`Email details for ID: ${emailId}\nThis feature will show full email content in a modal`);
        }

        async function createTestUser() {
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'edward.stead@gmail.com',
                        name: 'Edward Stead',
                        customEmailAddress: 'edward@parentpal.app',
                        phoneNumber: '+1234567890'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('User created:', { error: 'Failed to create user', details: errorText, status: response.status });
                    return null;
                }

                const user = await response.json();
                console.log('User created:', user);
                return user;
            } catch (error) {
                console.error('Error creating user:', error);
                console.log('User created:', { error: 'Failed to create user' });
                return null;
            }
        }

        async function syncGmail() {
            const tokens = localStorage.getItem('gmailTokens');
            if (!tokens) {
                alert('Please connect Gmail first');
                return;
            }

            // Check if domains are configured
            const domainsResponse = await fetch('/api/users/1/domains');
            const domainsData = await domainsResponse.json();
            const domains = domainsData.schoolDomains || [];

            // Get email settings
            const savedSettings = localStorage.getItem('emailSettings');
            const emailSettings = savedSettings ? JSON.parse(savedSettings) : { maxEmails: 20, emailDays: 7 };

            let statusMessage = 'üîÑ Syncing emails from Gmail API (Real Data)...';
            statusMessage += ` (Max: ${emailSettings.maxEmails} emails, ${emailSettings.emailDays} days)`;

            if (domains.length > 0) {
                statusMessage += ` Filtering by domains: ${domains.join(', ')}`;
            } else {
                statusMessage += ' Using default school domain patterns';
            }

            updateStatus(statusMessage);
            console.log('Syncing emails...');

            // Add visual indicator for real data processing
            const statusElement = document.getElementById('sync-status');
            if (statusElement) {
                statusElement.innerHTML += '<br><small style="color: #28a745;">üì° Fetching real emails from your Gmail account</small>';
            }

            try {
                const response = await fetch('/api/gmail/sync/1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tokens: JSON.parse(tokens) })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    if (response.status === 401 && errorResult.expired) {
                        updateStatus('‚úó Gmail authentication expired. Please reconnect your Gmail to continue syncing emails.');
                        return;
                    } else {
                        updateStatus(`‚úó Error: ${errorResult.error || 'Sync failed'}`);
                        console.error('Sync error response:', errorResult);
                        return;
                    }
                }

                const result = await response.json();
                if (result.success) {
                    let statusMessage = `‚úì ${result.message}`;

                    // Add duplicate handling feedback
                    if (result.duplicates && result.duplicates > 0) {
                        statusMessage += ` (${result.duplicates} duplicates skipped)`;
                    }

                    // Emphasize real data source
                    statusMessage += ' - üì° Real Gmail data processed';

                    updateStatus(statusMessage);
                    await loadEmailList();

                    // Update statistics
                    document.getElementById('emails-processed').textContent = result.processed || 0;
                    document.getElementById('last-sync').textContent = new Date().toLocaleString();

                    // Show real data confirmation
                    const emailList = document.getElementById('emailList');
                    if (emailList && result.processed > 0) {
                        const realDataBanner = document.createElement('div');
                        realDataBanner.style.cssText = 'background: #d4edda; border: 1px solid #c3e6cb; padding: 8px; margin: 10px 0; border-radius: 4px; color: #155724; font-size: 14px;';
                        realDataBanner.innerHTML = '‚úÖ <strong>Real Data:</strong> These emails were fetched from your actual Gmail account via Gmail API';
                        emailList.insertBefore(realDataBanner, emailList.firstChild);

                        // Remove banner after 10 seconds
                        setTimeout(() => realDataBanner.remove(), 10000);
                    }
                } else {
                    updateStatus(`‚úó Error: ${result.error}`);
                    console.error('Sync failed:', result);
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateStatus('‚úó Failed to sync emails');
            }
        }

        function startMonitoring() {
            const tokens = localStorage.getItem('gmailTokens');
            if (!tokens) {
                alert('Please connect Gmail first');
                return;
            }

            fetch('/api/gmail/monitor/1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tokens: JSON.parse(tokens), intervalMinutes: 5 })
            })
            .then(response => response.json())
            .then(data => {
                alert('Gmail monitoring started! Emails will be checked every 5 minutes.');
            })
            .catch(error => {
                console.error('Gmail monitoring error:', error);
                alert('Failed to start Gmail monitoring: ' + error.message);
            });
        }

        function checkGmailConnection() {
            // Force clear any invalid tokens first
            const rawTokens = localStorage.getItem('gmailTokens');
            if (rawTokens === 'null' || rawTokens === '{}' || rawTokens === 'undefined' || rawTokens === null) {
                localStorage.removeItem('gmailTokens');
            }

            // Get fresh token value after cleanup
            const tokens = localStorage.getItem('gmailTokens');
            const statusElement = document.getElementById('gmailStatus');
            const connectButtons = document.querySelectorAll('button[onclick="connectGmail()"]');
            const syncButtons = document.querySelectorAll('button[onclick="syncGmail()"]');

            console.log('Gmail connection check:', { 
                rawTokens: rawTokens,
                cleanedTokens: tokens,
                hasTokens: !!tokens,
                connectButtons: connectButtons.length, 
                syncButtons: syncButtons.length 
            });

            if (statusElement) {
                // Parse and validate tokens
                let validTokens = false;
                try {
                    if (tokens && tokens !== 'null' && tokens !== '{}' && tokens !== 'undefined') {
                        const parsedTokens = JSON.parse(tokens);
                        validTokens = parsedTokens && parsedTokens.access_token && parsedTokens.access_token.length > 0;
                        console.log('Token validation:', { 
                            tokensExist: !!parsedTokens, 
                            hasAccessToken: !!parsedTokens?.access_token,
                            accessTokenLength: parsedTokens?.access_token?.length,
                            validTokens 
                        });
                    }
                } catch (e) {
                    console.error('Error parsing tokens:', e);
                    validTokens = false;
                }

                if (validTokens) {
                    statusElement.innerHTML = `
                        <div class="alert alert-success">
                            <span class="status-indicator status-connected"></span>
                            <strong>Gmail Connected</strong><br>
                            Your Gmail account is connected and ready to sync school emails.
                        </div>
                    `;
                    // Enable sync button, disable connect button
                    connectButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.textContent = 'Gmail Connected';
                        btn.style.opacity = '0.6';
                    });
                    syncButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Sync Emails';
                        btn.style.opacity = '1';
                    });
                } else {
                    statusElement.innerHTML = `
                        <div class="alert alert-info">
                            <span class="status-indicator status-disconnected"></span>
                            <strong>Connect Gmail Account</strong><br>
                            Connect your Gmail to automatically sync school emails and extract events.
                        </div>
                    `;
                    // Enable connect button, disable sync button
                    connectButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.textContent = 'Connect Gmail';
                    });
                    syncButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.textContent = 'Sync Emails (Connect Gmail First)';
                    });
                }
            }
        }

        function debugOAuth() {
            const authURL = '/api/auth/google';
            const debugOutput = document.getElementById('debugOutput');
            const debugInfo = document.getElementById('debugInfo');

            if (debugOutput && debugInfo) {
                debugOutput.textContent = `Attempting to connect to: ${authURL}\n\n`;
                debugOutput.textContent += `localStorage['gmailTokens']: ${localStorage.getItem('gmailTokens')}\n`;
                debugOutput.textContent += `window.location.href: ${window.location.href}\n`;

                // Show the debug information
                debugInfo.style.display = 'block';
            }
        }

        // Settings functions
        function saveNotificationSettings(event) {
            event.preventDefault();

            const settings = {
                email: document.getElementById('notificationEmail').value,
                phone: document.getElementById('notificationPhone').value,
                dailyDigest: document.getElementById('dailyDigest').checked,
                urgentAlerts: document.getElementById('urgentAlerts').checked
            };

            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            alert('Notification settings saved!');
        }

        function saveGPTSettings(event) {
            event.preventDefault();

            const settings = {
                model: document.getElementById('gptModel').value,
                temperature: parseFloat(document.getElementById('gptTemperature').value),
                customInstructions: document.getElementById('customInstructions').value
            };

            localStorage.setItem('gptSettings', JSON.stringify(settings));
            alert('AI settings saved!');
        }

        function loadSavedSettings() {
            // Load GPT settings
            const gptSettings = localStorage.getItem('gptSettings');
            if (gptSettings) {
                const settings = JSON.parse(gptSettings);
                const modelSelect = document.getElementById('gptModel');
                const tempSlider = document.getElementById('gptTemperature');
                const customInstructions = document.getElementById('customInstructions');

                if (modelSelect) modelSelect.value = settings.model || 'gpt-4';
                if (tempSlider) {
                    tempSlider.value = settings.temperature || 0.3;
                    document.getElementById('temperatureValue').textContent = tempSlider.value;
                }
                if (customInstructions) customInstructions.value = settings.customInstructions || '';
            }

            // Load notification settings
            const notificationSettings = localStorage.getItem('notificationSettings');
            if (notificationSettings) {
                const settings = JSON.parse(notificationSettings);
                const emailInput = document.getElementById('notificationEmail');
                const phoneInput = document.getElementById('notificationPhone');
                const dailyDigest = document.getElementById('dailyDigest');
                const urgentAlerts = document.getElementById('urgentAlerts');

                if (emailInput) emailInput.value = settings.email || '';
                if (phoneInput) phoneInput.value = settings.phone || '';
                if (dailyDigest) dailyDigest.checked = settings.dailyDigest !== false;
                if (urgentAlerts) urgentAlerts.checked = settings.urgentAlerts !== false;
            }
        }

        // Temperature slider update
        document.addEventListener('DOMContentLoaded', function() {
            const tempSlider = document.getElementById('gptTemperature');
            const tempValue = document.getElementById('temperatureValue');

            if (tempSlider && tempValue) {
                tempSlider.addEventListener('input', function() {
                    tempValue.textContent = this.value;
                });
            }
        });

        // Event summary popup function
        function showEventSummary(emailId) {
            // Mock event data - replace with real data later
            const mockEventData = {
                1: {
                    title: "Parent-Teacher Conference",
                    date: "January 15, 2024 at 3:00 PM",
                    location: "Room 204",
                    description: "Quarterly academic review meeting"
                },
                2: {
                    title: "Soccer Practice Cancelled",
                    date: "January 15, 2024 at 4:00 PM", 
                    location: "School Field",
                    description: "Practice cancelled due to weather"
                }
            };

            const eventData = mockEventData[emailId];
            if (eventData) {
                alert(`Event Summary:\n\nTitle: ${eventData.title}\nDate: ${eventData.date}\nLocation: ${eventData.location}\nDescription: ${eventData.description}`);
            }
        }

        // Delete email function
        function deleteEmail(emailId) {
            if (confirm('Are you sure you want to remove this email from view?')) {
                console.log('Deleting email:', emailId);
                // Reload email list to reflect changes
                loadEmailList();
            }
        }

        // Listen for OAuth completion messages
        window.addEventListener('message', function(event) {
            // Handle both old string format and new object format for backward compatibility
            if (event.data === 'gmail-connected' || (event.data && event.data.type === 'gmail-connected')) {
                console.log('Gmail connection successful! Updating UI...');

                // Store tokens if provided in the new format
                if (event.data && event.data.tokens) {
                    localStorage.setItem('gmailTokens', JSON.stringify(event.data.tokens));
                    console.log('Tokens stored from OAuth callback:', { 
                        hasTokens: true,
                        hasAccessToken: !!event.data.tokens.access_token,
                        hasRefreshToken: !!event.data.tokens.refresh_token
                    });
                }

                // Update UI immediately
                setTimeout(() => {
                    const storedTokens = localStorage.getItem('gmailTokens');
                    console.log('Tokens after OAuth completion:', { 
                        hasTokens: !!storedTokens,
                        firstChars: storedTokens?.substring(0, 50) + '...'
                    });

                    checkGmailConnection();
                    alert('Gmail connected successfully! You can now sync your emails.');
                }, 100);
            } else if (event.data === 'gmail-error') {
                console.error('Gmail connection failed');
                alert('Gmail connection failed. Please try again.');
            }
        });

        // Domain management functions
        async function loadDomains() {
            const container = document.getElementById('domains-container');
            if (!container) return;

            try {
                const response = await fetch('/api/users/1/domains');
                if (response.ok) {
                    const user = await response.json();
                    const domains = user.schoolDomains || [];

                    if (domains.length === 0) {
                        container.innerHTML = '<p style="color: #666; font-style: italic;">No domains configured yet. Add domains above to filter school emails.</p>';
                    } else {
                        container.innerHTML = domains.map(domain => 
                            `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; margin: 5px 0;">
                                <span style="font-family: monospace;">${domain}</span>
                                <button onclick="removeDomain('${domain}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Remove</button>
                            </div>`
                        ).join('');
                    }
                } else {
                    container.innerHTML = '<p style="color: #dc3545;">Failed to load domains</p>';
                }
            } catch (error) {
                console.error('Error loading domains:', error);
                container.innerHTML = '<p style="color: #dc3545;">Error loading domains</p>';
            }
        }

        async function addDomain() {
            const input = document.getElementById('domain-input');
            const domain = input.value.trim();

            if (!domain) {
                alert('Please enter a domain name');
                return;
            }

            // Basic domain validation
            if (!domain.includes('.') || domain.includes('@') || domain.includes('http')) {
                alert('Please enter a valid domain name (e.g., "school.edu")');
                return;
            }

            try {
                const response = await fetch('/api/users/1/domains', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain })
                });

                if (response.ok) {
                    input.value = '';
                    loadDomains();
                    alert('Domain added successfully!');
                } else {
                    const error = await response.text();
                    alert('Failed to add domain: ' + error);
                }
            } catch (error) {
                console.error('Error adding domain:', error);
                alert('Error adding domain');
            }
        }

        async function removeDomain(domain) {
            if (!confirm(`Remove domain "${domain}"?`)) return;

            try {
                const response = await fetch('/api/users/1/domains', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain })
                });

                if (response.ok) {
                    loadDomains();
                    alert('Domain removed successfully!');
                } else {
                    const error = await response.text();
                    alert('Failed to remove domain: ' + error);
                }
            } catch (error) {
                console.error('Error removing domain:', error);
                alert('Error removing domain');
            }
        }

        // Load processing statistics
        async function loadProcessingStats() {
            try {
                const response = await fetch('/api/users/1/stats');
                if (response.ok) {
                    const stats = await response.json();

                    const emailsProcessed = document.getElementById('emails-processed');
                    const eventsExtracted = document.getElementById('events-extracted');
                    const lastSync = document.getElementById('last-sync');

                    if (emailsProcessed) emailsProcessed.textContent = stats.emailsProcessed || 0;
                    if (eventsExtracted) eventsExtracted.textContent = stats.eventsExtracted || 0;
                    if (lastSync) lastSync.textContent = stats.lastSync || 'Never';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function saveEmailSettings() {
            const maxEmails = document.getElementById('max-emails').value;
            const emailDays = document.getElementById('email-days').value;

            const settings = {
                maxEmails: parseInt(maxEmails, 10) || 20,
                emailDays: parseInt(emailDays, 10) || 7
            };

            localStorage.setItem('emailSettings', JSON.stringify(settings));
            alert('Email settings saved!');
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');

            // Only clear invalid cached tokens (not all tokens)
            const tokens = localStorage.getItem('gmailTokens');
            if (tokens === 'null' || tokens === '{}' || tokens === 'undefined') {
                localStorage.removeItem('gmailTokens');
                console.log('Cleared invalid cached tokens');
            }

            // Show dashboard by default, but preserve current tab if already set
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const currentTab = urlParams.get('tab') || localStorage.getItem('currentTab') || 'dashboard';
            showTab(currentTab);

            // Check Gmail connection status
            checkGmailConnection();

            // Load domain settings and stats if Gmail tab is active
            if (currentTab === 'gmail') {
                loadDomains();
                loadProcessingStats();
            }
        });

        function updateStatus(message) {
            console.log(message);
        }
    </script>
</body>
</html>