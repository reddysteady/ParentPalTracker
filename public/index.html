<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParentPal - School Email & Schedule Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 24px;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .event-item, .child-item {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .event-date {
            font-weight: bold;
            color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background-color: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                margin-bottom: 5px;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ParentPal</h1>
            <p class="subtitle">Smart School Email & Schedule Management</p>
        </div>
    </header>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('children')">Children</button>
            <button class="nav-tab" onclick="showTab('events')">Events</button>
            <button class="nav-tab" onclick="showTab('gmail')">Gmail Integration</button>
            <button class="nav-tab" onclick="showTab('settings')">Settings</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h3>üìÖ Today's Events</h3>
                    <div id="todayEvents">
                        <div class="loading">Loading today's events...</div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä System Status</h3>
                    <div id="dashboardStatus">
                        <div class="loading">Checking system status...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üéØ Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showTab('children')" class="btn-secondary">Add Child</button>
                    <button onclick="showTab('events')" class="btn-secondary">Add Event</button>
                    <button onclick="connectGmail()" class="btn-success">Connect Gmail</button>
                    <button onclick="syncGmail()" class="btn-secondary">Sync Emails</button>
                </div>
            </div>
        </div>

        <!-- Children Tab -->
        <div id="children" class="tab-content">
            <div class="card">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Add New Child</h3>
                <form onsubmit="addChild(event)">
                    <div class="form-group">
                        <label for="childName">Child's Name:</label>
                        <input type="text" id="childName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="childGrade">Grade:</label>
                        <input type="text" id="childGrade" name="grade" required>
                    </div>
                    <div class="form-group">
                        <label for="childSchool">School:</label>
                        <input type="text" id="childSchool" name="school" required>
                    </div>
                    <button type="submit">Add Child</button>
                </form>
            </div>

            <div class="card">
                <h3>üìã Your Children</h3>
                <div id="childrenList">
                    <div class="loading">Loading children...</div>
                </div>
            </div>
        </div>

        <!-- Events Tab -->
        <div id="events" class="tab-content">
            <div class="card">
                <h3>üìÖ Add New Event</h3>
                <form onsubmit="addEvent(event)">
                    <div class="form-group">
                        <label for="eventTitle">Event Title:</label>
                        <input type="text" id="eventTitle" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDate">Date:</label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventTime">Time:</label>
                        <input type="time" id="eventTime" name="eventTime">
                    </div>
                    <div class="form-group">
                        <label for="eventChild">Child:</label>
                        <select id="eventChild" name="childId">
                            <option value="">Select a child</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventDescription">Description:</label>
                        <textarea id="eventDescription" name="description" rows="3"></textarea>
                    </div>
                    <button type="submit">Add Event</button>
                </form>
            </div>

            <div class="card">
                <h3>üìã Upcoming Events</h3>
                <div id="eventsList">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>

        <!-- Gmail Integration Tab -->
        <div id="gmail" class="tab-content">
            <div class="card">
                <h3>üìß Gmail Integration</h3>
                <div id="gmailStatus">
                    <div class="loading">Checking Gmail connection...</div>
                </div>

                <div style="margin-top: 20px;">
                    <button onclick="connectGmail()" class="btn-success">Connect Gmail</button>
                    <button onclick="syncGmail()" class="btn-secondary" style="margin-left: 10px;">Sync Emails</button>
                    <button onclick="startMonitoring()" class="btn-secondary" style="margin-left: 10px;">Start Monitoring</button>
                    <button onclick="debugOAuth()" class="btn-secondary" style="margin-left: 10px;">Debug OAuth</button>
                </div>

                <div id="debugInfo" style="margin-top: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 5px; display: none;">
                    <h4>OAuth Debug Information</h4>
                    <pre id="debugOutput"></pre>
                </div>

                <div style="margin-top: 20px;">
                    <h4>How it works:</h4>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Connect your Gmail account securely</li>
                        <li>We'll scan for school-related emails</li>
                        <li>Events are automatically extracted and added to your calendar</li>
                        <li>You'll get smart notifications based on your parenting schedule</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>üîî Notification Settings</h3>
                    <form onsubmit="saveNotificationSettings(event)">
                        <div class="form-group">
                            <label for="notificationEmail">Email for notifications:</label>
                            <input type="email" id="notificationEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label for="notificationPhone">Phone for SMS alerts:</label>
                            <input type="tel" id="notificationPhone" name="phone">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="dailyDigest" name="dailyDigest"> Daily digest emails
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="urgentAlerts" name="urgentAlerts"> Urgent SMS alerts
                            </label>
                        </div>
                        <button type="submit">Save Settings</button>
                    </form>
                </div>

                <div class="card">
                    <h3>ü§ñ AI Settings</h3>
                    <form onsubmit="saveGPTSettings(event)">
                        <div class="form-group">
                            <label for="gptModel">AI Model:</label>
                            <select id="gptModel" name="model">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gptTemperature">Response Style (0.0 = Precise, 1.0 = Creative):</label>
                            <input type="range" id="gptTemperature" name="temperature" min="0" max="1" step="0.1" value="0.3">
                            <span id="temperatureValue">0.3</span>
                        </div>
                        <div class="form-group">
                            <label for="customInstructions">Custom Instructions:</label>
                            <textarea id="customInstructions" name="customInstructions" rows="4" placeholder="Add any specific instructions for how the AI should process your emails..."></textarea>
                        </div>
                        <button type="submit">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let gmailTokens = null;

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                if (content && content.classList) {
                    content.classList.remove('active');
                }
            });

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                if (tab && tab.classList) {
                    tab.classList.remove('active');
                }
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabName);
            if (selectedTab && selectedTab.classList) {
                selectedTab.classList.add('active');
            }

            // Add active class to clicked tab
            const clickedTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (clickedTab && clickedTab.classList) {
                clickedTab.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'events') {
                loadEvents();
                loadChildrenOptions();
            } else if (tabName === 'children') {
                loadChildren();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'gmail') {
                checkGmailConnection();
            }
        }

        // Dashboard functions
        function loadDashboard() {
            fetch('/api/health')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const statusElement = document.getElementById('dashboardStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div>
                                <span class="status-indicator status-connected"></span>
                                Server is running
                            </div>
                            <p style="margin-top: 10px; color: #666;">Last updated: ${new Date(data.timestamp).toLocaleString()}</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard:', error);
                    const statusElement = document.getElementById('dashboardStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div>
                                <span class="status-indicator status-disconnected"></span>
                                Server connection failed
                            </div>
                            <p style="margin-top: 10px; color: #dc3545;">Error: ${error.message}</p>
                        `;
                    }
                });

            loadTodayEvents();
        }

        function loadTodayEvents() {
            fetch('/api/events')
                .then(response => response.json())
                .then(events => {
                    const today = new Date().toDateString();
                    const todayEvents = events.filter(event => {
                        return new Date(event.eventDate).toDateString() === today;
                    });

                    const container = document.getElementById('todayEvents');
                    if (container) {
                        if (todayEvents.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No events scheduled for today</p>';
                        } else {
                            container.innerHTML = todayEvents.map(event => `
                                <div class="event-item">
                                    <div class="event-date">${event.title}</div>
                                    <div>${event.eventTime ? `Time: ${event.eventTime}` : 'All day'}</div>
                                    ${event.description ? `<div style="margin-top: 5px; color: #666;">${event.description}</div>` : ''}
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading today events:', error);
                    const container = document.getElementById('todayEvents');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load events</div>`;
                    }
                });
        }

        // Children management
        function addChild(event) {
            event.preventDefault();

            const childData = {
                name: document.getElementById('childName').value,
                grade: document.getElementById('childGrade').value,
                school: document.getElementById('childSchool').value
            };

            fetch('/api/children', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(childData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Child added successfully!');
                event.target.reset();
                loadChildren();
                loadChildrenOptions();
            })
            .catch(error => {
                console.error('Error adding child:', error);
                alert('Error adding child: ' + error.message);
            });
        }

        function loadChildren() {
            fetch('/api/children')
                .then(response => response.json())
                .then(children => {
                    const container = document.getElementById('childrenList');
                    if (container) {
                        if (children.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No children added yet. Add your first child above!</p>';
                        } else {
                            container.innerHTML = children.map(child => `
                                <div class="child-item">
                                    <h4>${child.name}</h4>
                                    <p>Grade: ${child.grade} | School: ${child.school}</p>
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading children:', error);
                    const container = document.getElementById('childrenList');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load children</div>`;
                    }
                });
        }

        function loadChildrenOptions() {
            fetch('/api/children')
                .then(response => response.json())
                .then(children => {
                    const select = document.getElementById('eventChild');
                    if (select) {
                        select.innerHTML = '<option value="">Select a child</option>';
                        children.forEach(child => {
                            const option = document.createElement('option');
                            option.value = child.id;
                            option.textContent = child.name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading children options:', error);
                });
        }

        // Events management
        function addEvent(event) {
            event.preventDefault();

            const eventData = {
                title: document.getElementById('eventTitle').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                childId: document.getElementById('eventChild').value || null,
                description: document.getElementById('eventDescription').value
            };

            fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Event added successfully!');
                event.target.reset();
                loadEvents();
                loadTodayEvents();
            })
            .catch(error => {
                console.error('Error adding event:', error);
                alert('Error adding event: ' + error.message);
            });
        }

        function loadEvents() {
            fetch('/api/events')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(events => {
                    const container = document.getElementById('eventsList');
                    if (container) {
                        if (events.length === 0) {
                            container.innerHTML = '<p style="color: #666;">No events scheduled. Add your first event above!</p>';
                        } else {
                            // Sort events by date
                            events.sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));

                            container.innerHTML = events.map(event => `
                                <div class="event-item">
                                    <div class="event-date">${new Date(event.eventDate).toDateString()}</div>
                                    <h4>${event.title}</h4>
                                    ${event.eventTime ? `<p>Time: ${event.eventTime}</p>` : ''}
                                    ${event.description ? `<p style="color: #666;">${event.description}</p>` : ''}
                                </div>
                            `).join('');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    const container = document.getElementById('eventsList');
                    if (container) {
                        container.innerHTML = `<div class="error-message">Failed to load events: ${error.message}</div>`;
                    }
                });
        }

        // Gmail integration functions
        function connectGmail() {
            window.location.href = '/api/auth/google';
        }

        function syncGmail() {
            const tokens = localStorage.getItem('gmailTokens');
            if (!tokens) {
                alert('Please connect Gmail first');
                return;
            }

            const syncButton = document.querySelector('button[onclick="syncGmail()"]');
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.textContent = 'Syncing...';
            }

            fetch('/api/gmail/sync/1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tokens: JSON.parse(tokens) })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Gmail sync completed: ${data.processed || 0} emails processed`);
                loadEvents();
                loadTodayEvents();
            })
            .catch(error => {
                console.error('Gmail sync error:', error);
                alert('Gmail sync failed: ' + error.message);
            })
            .finally(() => {
                if (syncButton) {
                    syncButton.disabled = false;
                    syncButton.textContent = 'Sync Emails';
                }
            });
        }

        function startMonitoring() {
            const tokens = localStorage.getItem('gmailTokens');
            if (!tokens) {
                alert('Please connect Gmail first');
                return;
            }

            fetch('/api/gmail/monitor/1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tokens: JSON.parse(tokens), intervalMinutes: 5 })
            })
            .then(response => response.json())
            .then(data => {
                alert('Gmail monitoring started! Emails will be checked every 5 minutes.');
            })
            .catch(error => {
                console.error('Gmail monitoring error:', error);
                alert('Failed to start Gmail monitoring: ' + error.message);
            });
        }

        function checkGmailConnection() {
            const tokens = localStorage.getItem('gmailTokens');
            const statusElement = document.getElementById('gmailStatus');

            if (statusElement) {
                if (tokens) {
                    statusElement.innerHTML = `
                        <div class="alert alert-success">
                            <span class="status-indicator status-connected"></span>
                            Gmail is connected and ready to sync
                        </div>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div class="alert alert-info">
                            <span class="status-indicator status-disconnected"></span>
                            Gmail not connected. Click "Connect Gmail" to get started.
                        </div>
                    `;
                }
            }
        }

        function debugOAuth() {
            const authURL = '/api/auth/google';
            const debugOutput = document.getElementById('debugOutput');
            const debugInfo = document.getElementById('debugInfo');

            if (debugOutput && debugInfo) {
                debugOutput.textContent = `Attempting to connect to: ${authURL}\n\n`;
                debugOutput.textContent += `localStorage['gmailTokens']: ${localStorage.getItem('gmailTokens')}\n`;
                debugOutput.textContent += `window.location.href: ${window.location.href}\n`;

                // Show the debug information
                debugInfo.style.display = 'block';
            }
        }

        // Settings functions
        function saveNotificationSettings(event) {
            event.preventDefault();

            const settings = {
                email: document.getElementById('notificationEmail').value,
                phone: document.getElementById('notificationPhone').value,
                dailyDigest: document.getElementById('dailyDigest').checked,
                urgentAlerts: document.getElementById('urgentAlerts').checked
            };

            localStorage.setItem('notificationSettings', JSON.stringify(settings));
            alert('Notification settings saved!');
        }

        function saveGPTSettings(event) {
            event.preventDefault();

            const settings = {
                model: document.getElementById('gptModel').value,
                temperature: parseFloat(document.getElementById('gptTemperature').value),
                customInstructions: document.getElementById('customInstructions').value
            };

            localStorage.setItem('gptSettings', JSON.stringify(settings));
            alert('AI settings saved!');
        }

        function loadSavedSettings() {
            // Load GPT settings
            const gptSettings = localStorage.getItem('gptSettings');
            if (gptSettings) {
                const settings = JSON.parse(gptSettings);
                const modelSelect = document.getElementById('gptModel');
                const tempSlider = document.getElementById('gptTemperature');
                const customInstructions = document.getElementById('customInstructions');

                if (modelSelect) modelSelect.value = settings.model || 'gpt-4';
                if (tempSlider) {
                    tempSlider.value = settings.temperature || 0.3;
                    document.getElementById('temperatureValue').textContent = tempSlider.value;
                }
                if (customInstructions) customInstructions.value = settings.customInstructions || '';
            }

            // Load notification settings
            const notificationSettings = localStorage.getItem('notificationSettings');
            if (notificationSettings) {
                const settings = JSON.parse(notificationSettings);
                const emailInput = document.getElementById('notificationEmail');
                const phoneInput = document.getElementById('notificationPhone');
                const dailyDigest = document.getElementById('dailyDigest');
                const urgentAlerts = document.getElementById('urgentAlerts');

                if (emailInput) emailInput.value = settings.email || '';
                if (phoneInput) phoneInput.value = settings.phone || '';
                if (dailyDigest) dailyDigest.checked = settings.dailyDigest !== false;
                if (urgentAlerts) urgentAlerts.checked = settings.urgentAlerts !== false;
            }
        }

        // Temperature slider update
        document.addEventListener('DOMContentLoaded', function() {
            const tempSlider = document.getElementById('gptTemperature');
            const tempValue = document.getElementById('temperatureValue');

            if (tempSlider && tempValue) {
                tempSlider.addEventListener('input', function() {
                    tempValue.textContent = this.value;
                });
            }
        });

        // Prevent multiple initializations
        let appInitialized = false;

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (appInitialized) return;
            appInitialized = true;

            console.log('DOM loaded, initializing app...');

            // Wait a moment for DOM to be fully ready
            setTimeout(() => {
                try {
                    // Set default tab
                    showTab('dashboard');

                    // Load initial data with error handling
                    loadDashboard();
                    loadChildren();
                    loadChildrenOptions();
                    loadEvents();

                    // Handle OAuth tokens from URL params
                    const urlParams = new URLSearchParams(window.location.search);
                    const tokensParam = urlParams.get('tokens');
                    const error = urlParams.get('error');
                    const details = urlParams.get('details');

                    if (tokensParam) {
                        try {
                            const tokens = JSON.parse(decodeURIComponent(tokensParam));
                            console.log('Gmail OAuth tokens received:', tokens);
                            alert('Gmail connected successfully! You can now sync your emails.');
                            // Clean up URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } catch (e) {
                            console.error('Error parsing tokens:', e);
                            alert('Error connecting to Gmail');
                        }
                    }

                    if (error) {
                        console.error('Gmail OAuth error:', error, details);
                        alert(`Gmail connection failed: ${decodeURIComponent(details || error)}`);
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (err) {
                    console.error('Error during app initialization:', err);
                }
            }, 100);
        });
    </script>
</body>
</html>